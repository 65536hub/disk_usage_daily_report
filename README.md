本スクリプトは、UNIX系のサーバ上のディレクトリ容量を日次で記録し、前日との差分を算出してメールで通知するための自動化ツールです。

ログ収集基盤が十分整っていない環境や、メールクライアントが利用できない制約のあるサーバを想定し、軽量なシェルスクリプトのみで完結するように設計しています。

---

## 1. 目的

- サーバストレージの増加を日次で可視化し、異常な容量増加（ログ肥大化・アプリケーション暴走等）を早期に検知する。
- ログ収集製品や監視ツール（Zabbix / Datadog など）が配置できない環境でも最低限の監視を実現する。
- メールクライアントがインストールされていない環境でも SMTP（telnet）経由で通知できるようにする。

---

## 2. 主な機能

### ✔ 日次でディレクトリ容量を取得  
`du` コマンドを利用し、サーバ直下のディレクトリサイズを GB 単位で取得します。

### ✔ 前日との差分を算出  
過去ファイルと比較し、  
- 増加（+X GB）  
- 減少（-X GB）  
- 変化なし  

を一覧化します。

### ✔ SMTP（telnet）で結果をメール通知  
メールコマンドが利用できない環境を想定し、telnet を利用した SMTP 通信を実装しています。

### ✔ ロケール固定（LANG=C）  
各種コマンドの動作を安定させるため、ロケール依存を排除しています。

---

## 3. スクリプト構成

- disk_usage_daily_report.sh  # 本体スクリプト
- /data/storage/              # 対象ディレクトリ（例）
- /data/storage/monitoring/   # 差分リスト保存先

## 4. 処理の流れ

1. 環境変数の読み込み（LANG、メール設定）
2. 今日/昨日の容量リストファイルの存在チェック
3. ディレクトリ容量を取得し、今日用リストを作成
4. awk により今日と昨日の差分を算出
5. telnet 経由で SMTP サーバへ送信し、メールにて通知

---

## 5. 実行方法

・手動で実行する場合
bash disk_check.sh

・cronで自動実行する場合(推奨)

0 2 * * * /usr/local/bin/disk_check.sh

## 6. 出力例
- MAIL_TO で指定した宛先に、出力結果がメール本文として送信されます。
- 取得したディレクトリの使用量を、使用量の大きい順に並べて表示します。
- 前回との差分（増減） を表示します。増加は +、減少は - で表記します。
- 10MB未満のディレクトリは 0.00GB として表示されます。

```
例)

739.33GB project_build                   -0.53GB
356.72GB team_data                       
238.51GB project_sales                   +1.12GB
129.03GB sec_ops                         
81.57GB  creative_ops                    +0.01GB
68.41GB  legacy_project                                    
6.78GB   hr_archive                                                          
0.00GB   cloud_documents                 
0.00GB   research_data
```

